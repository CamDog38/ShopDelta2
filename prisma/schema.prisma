generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime? @db.Timestamptz(6)
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)

  @@map("session")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model plan {
  id           String         @id
  key          String         @unique
  name         String
  price        Decimal        @db.Decimal(10, 2)
  interval     String
  active       Boolean        @default(true)
  created_at   DateTime       @default(now()) @db.Timestamptz(6)
  updated_at   DateTime       @default(now()) @db.Timestamptz(6)
  shop         shop[]
  subscription subscription[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model shop {
  id                                              String         @id
  domain                                          String         @unique
  created_at                                      DateTime       @default(now()) @db.Timestamptz(6)
  updated_at                                      DateTime       @default(now()) @db.Timestamptz(6)
  current_plan_id                                 String?
  subscription_id                                 String?
  plan                                            plan?          @relation(fields: [current_plan_id], references: [id], map: "fk_shop_current_plan")
  subscription_shop_subscription_idTosubscription subscription?  @relation("shop_subscription_idTosubscription", fields: [subscription_id], references: [id], map: "fk_shop_subscription")
  subscription_subscription_shop_idToshop         subscription[] @relation("subscription_shop_idToshop")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model subscription {
  id                                      String               @id
  shop_id                                 String
  plan_id                                 String?
  shopify_subscription_gid                String?
  status                                  subscription_status
  trial_ends_at                           DateTime?            @db.Timestamptz(6)
  current_period_start                    DateTime?            @db.Timestamptz(6)
  current_period_end                      DateTime?            @db.Timestamptz(6)
  is_test                                 Boolean              @default(false)
  created_at                              DateTime             @default(now()) @db.Timestamptz(6)
  updated_at                              DateTime             @default(now()) @db.Timestamptz(6)
  shop_shop_subscription_idTosubscription shop[]               @relation("shop_subscription_idTosubscription")
  plan                                    plan?                @relation(fields: [plan_id], references: [id], map: "fk_subscription_plan")
  shop_subscription_shop_idToshop         shop                 @relation("subscription_shop_idToshop", fields: [shop_id], references: [id], map: "fk_subscription_shop")
  subscription_event                      subscription_event[]

  @@index([plan_id], map: "idx_subscription_plan_id")
  @@index([shop_id], map: "idx_subscription_shop_id")
  @@index([status], map: "idx_subscription_status")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model subscription_event {
  id              String                  @id
  subscription_id String
  type            subscription_event_type
  payload         Json?
  created_at      DateTime                @default(now()) @db.Timestamptz(6)
  subscription    subscription            @relation(fields: [subscription_id], references: [id], onDelete: Cascade, map: "fk_event_subscription")

  @@index([subscription_id], map: "idx_subscription_event_subscription_id")
}

enum subscription_event_type {
  CREATED
  ACTIVATED
  CANCELLED
  RENEWED
  FAILED
  UPDATED
}

enum subscription_status {
  ACTIVE
  PENDING
  CANCELLED
  EXPIRED
}

// =====================================================
// ShopDelta - Shopify App (SApp) Models
// Wrapped Video Sharing Feature
// =====================================================

/// Stores Shopify shop information for the Wrapped feature
/// This model contains row level security and requires additional setup for migrations.
model SApp_Shop {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shopify_domain  String   @unique @db.VarChar(255)
  shop_name       String?  @db.VarChar(255)
  currency_code   String   @default("USD") @db.VarChar(10)
  access_token    String?  @db.Text
  scope           String?  @db.Text
  is_active       Boolean  @default(true)
  installed_at    DateTime @default(now()) @db.Timestamptz(6)
  uninstalled_at  DateTime? @db.Timestamptz(6)
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)

  wrapped_shares  SApp_WrappedShare[]

  @@index([shopify_domain], map: "idx_sapp_shops_domain")
  @@map("SApp_Shops")
}

/// Stores shareable links for Wrapped videos
/// This model contains row level security and requires additional setup for migrations.
model SApp_WrappedShare {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shop_id               String    @db.Uuid
  
  // Share identification
  share_code            String    @unique @db.VarChar(32)
  title                 String?   @db.VarChar(255)
  
  // Wrapped configuration
  wrap_mode             String    @default("year") @db.VarChar(20)
  year_a                Int?      // comparison year (previous)
  year_b                Int?      // current year
  month                 Int?      // for month mode (1-12)
  
  // Cached analytics data
  analytics_data        Json?     @db.JsonB
  slides_data           Json?     @db.JsonB
  
  // Access control
  password_hash         String?   @db.VarChar(255)
  is_password_protected Boolean   @default(false)
  
  // Time-based access
  expires_at            DateTime? @db.Timestamptz(6)
  starts_at             DateTime  @default(now()) @db.Timestamptz(6)
  
  // Status
  is_active             Boolean   @default(true)
  is_revoked            Boolean   @default(false)
  revoked_at            DateTime? @db.Timestamptz(6)
  
  // Analytics
  view_count            Int       @default(0)
  last_viewed_at        DateTime? @db.Timestamptz(6)
  
  // Metadata
  created_by            String?   @db.VarChar(255)
  created_at            DateTime  @default(now()) @db.Timestamptz(6)
  updated_at            DateTime  @default(now()) @db.Timestamptz(6)

  shop                  SApp_Shop @relation(fields: [shop_id], references: [id], onDelete: Cascade)
  views                 SApp_WrappedShareView[]

  @@index([shop_id], map: "idx_sapp_wrapped_shares_shop")
  @@index([share_code], map: "idx_sapp_wrapped_shares_code")
  @@index([is_active, is_revoked], map: "idx_sapp_wrapped_shares_active")
  @@map("SApp_WrappedShares")
}

/// Tracks individual views of shared Wrapped videos
/// This model contains row level security and requires additional setup for migrations.
model SApp_WrappedShareView {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  share_id         String   @db.Uuid
  
  // Viewer info (anonymized)
  viewer_ip_hash   String?  @db.VarChar(64)
  user_agent       String?  @db.Text
  referrer         String?  @db.Text
  country_code     String?  @db.VarChar(2)
  
  // View details
  viewed_at        DateTime @default(now()) @db.Timestamptz(6)
  slides_viewed    Int      @default(0)
  completed        Boolean  @default(false)
  duration_seconds Int?

  share            SApp_WrappedShare @relation(fields: [share_id], references: [id], onDelete: Cascade)

  @@index([share_id], map: "idx_sapp_share_views_share")
  @@index([viewed_at], map: "idx_sapp_share_views_date")
  @@map("SApp_WrappedShareViews")
}
